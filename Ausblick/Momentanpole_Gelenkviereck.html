<!doctype html>
<html>

<head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rastpolbahn</title>
</head>

<body>
    <h1 style="text-align:center;width:98vw">Momentanpole</h1>
    <pre id="out">?</pre>
    <canvas id="c" width="1201" height="801" style="border:1px solid black;background-color:transparent;"></canvas><br>
    <span id="out"></span>
    <script src="./../../g2-ng/g2.js"></script>
    <script src="./../../cstr2/cstr.js"></script>

    <script>
        const ctx = document.getElementById('c').getContext('2d');
        const interactor = canvasInteractor.create(ctx, { x: 140, y: 140, cartesian: true });
        const selector = g2.selectorHdl(interactor.evt);  // sharing 'evt' object ... !

        const P12 = { x: 0, y: 0, base: true, label: { str: 'P12', loc: 'sw' } },
            P24 = { x: 0, y: 50, label: { str: 'P24', loc: 'nw' } },
            P34 = { x: 120, y: 140, label: { str: 'P34', loc: 'ne' } },
            P13 = { x: 200, y: 40, base: true, label: { str: 'P13', loc: 'se' } },
            Q14 = { x: 60, y: 140, label: "Q14" },
            Q13 = { x: 60, y: 140, label: "Q13" };
        let phiKurbel = Math.atan2(P24.y, P24.x);
        let KK = [],
            Q13_K = [];


        const c = cstr().n2({ id: 'P12P24', n1: P12, n2: P24, len: 'const', ang: "const" })
            .n2({ id: 'AB', n1: P24, n2: P34, len: 'const' })
            .n2({ id: 'B0B', n1: P13, n2: P34, len: 'const' })
            .n3({ n1: P12, n2: P24, n3: Q14, ang: '0' })
            .n3({ n1: P13, n2: P34, n3: Q14, ang: '0' })
            .n3({ n1: P12, n2: P13, n3: Q13, ang: '0' })
            .n3({ n1: P24, n2: P34, n3: Q13, ang: '0' })
        const crank = c.byId('P12P24');
        const g = g2().clr()                           // important with 'interaction'
            .view(interactor.view)           // view sharing ... !
            .ply({ pts: [P12, P24, P34, P13], lw: 3, ls: 'darkslategray', closed: true })
            .ply({ pts: [P12, P24, Q14, P13, P34], lw: 1, ls: 'darkslategray', closed: false })
            .ply({ pts: [P34, P24, Q13, P12, P13], lw: 1, ls: 'darkslategray', closed: false })
            .gnd(P12)
            .nod(P24)
            .nod(P34)
            .gnd(P13)
            .ply({ pts: KK, lw: 2, ls: 'green', ld: [3, 3], closed: false })
            .ply({ pts: Q13_K, lw: 2, ls: 'orange', ld: [3, 3], closed: false })
            .nod(Q14)
            .nod(Q13)
        g.exe(ctx);


        let itrmax = 0;

        interactor
            .init((e) => {  // create coupler curve
                const w0 = crank.ang;
                for (let w = 0; w <= 2 * Math.PI; w += Math.PI / 90) {
                    crank.ang = w0 + w;
                    c.correct();
                    KK.push({ x: Q14.x, y: Q14.y });
                    Q13_K.push({ x: Q13.x, y: Q13.y });
                }
                crank.ang = w0;
            })
            .on('tick', (e) => {
                crank.ang += Math.PI / 180;
                phiKurbel = crank.ang;
                const itr = c.correct();
                document.getElementById('out').innerHTML = `itr(max/cur) = ${itrmax = Math.max(itr, itrmax)} / ${itr}`;
                g.exe(ctx);
                if (crank.ang >= 130 * Math.PI / 2)
                    interactor.endTimer();
            })
            .on('pan', (e) => { interactor.view.x += e.dx; interactor.view.y += e.dy; })
            .startTimer();

    </script>
</body>

</html>